---
title: "Population estimates"
author: "Hannah"
format: html
editor: visual
---

## Population, death, natality, and migration estimates

Migration estimates come from the IRS county-level migration files. Population, birth, and death estimates come from the National Vital Statistics System via CDC WONDER. All data are available for public use, and therefore many values are suppressed.

Documentation on [natality estimates is available here](https://wonder.cdc.gov/wonder/help/Natality-expanded.html#).

Documentation on [mortality and population estimates is available here](https://wonder.cdc.gov/ucd-icd10.html).

Note that though the analysis in this document does not require mortality estimates, the age-adjusted mortality rates in the datasets wrangled below are premature (under age 75) age-adjusted rates.

```{r, include = FALSE}
###################################################################################
# 1) premature mortality data 
#################################################################################
library(dplyr)

mort1 = read.delim(file = "data_raw/premature_norace1119.txt")

mort1 = mort1[!is.na(mort1$State.Code),]
mort1$state_fips = stringr::str_pad(mort1$State.Code, 2, pad = "0")
mort1$county_fips = substr(mort1$County.Code, nchar(mort1$County.Code)-3+1, nchar(mort1$County.Code))
mort1$fips = paste0(mort1$state_fips, mort1$county_fips)
mort1$agerate = as.numeric(mort1$Age.Adjusted.Rate)
mort = mort1 %>% select(Year, state_fips, county_fips, fips, agerate, Deaths, Population)

 
#no evidence of duplicates 
dups =mort %>% group_by(Year, fips) %>% filter(n()>1) 


#only run the following lines if want to change final premature mort file 
# save(mort, file = "data_processed/premature_norace_1119_processed.RData")





  ###################################################################################
### 2) migration data 
#################################################################################

library(data.table)
library(stringi)
library(haven)
library(dplyr)
cfips = haven::read_sas("data_raw/county_fips.sas7bdat")




infile_names <- list.files(path = "data_raw/IRSmig1120", pattern= 'countyinflow', full.names = F, recursive = F)
outfile_names <- list.files(path = "data_raw/IRSmig1120", pattern= 'countyoutflow', full.names = F, recursive = F)


years = c("1112", "1213", "1314", "1415", "1516", "1617", "1718", "1819", "1920")

inout = data.frame() 

for (i in 1:length(years)){
  in1 = read.csv(paste0("data_raw/IRSmig1120/", infile_names[i]))
  in1$y2_statefips = stringr::str_pad(in1$y2_statefips, 2, pad = "0")
  in1$y2_countyfips = stringr::str_pad(in1$y2_countyfips, 3, pad = "0")
  in1$y1_statefips = stringr::str_pad(in1$y1_statefips, 2, pad = "0")
  in1$y1_countyfips = stringr::str_pad(in1$y1_countyfips, 3, pad = "0")
  
  in1$destid = paste0(in1$y2_statefips, in1$y2_countyfips)
  in1$origid = paste0(in1$y1_statefips, in1$y1_countyfips)
  in1sub = in1[,c("n2", "destid", "origid")]
  in1sub$year = years[i]
  
  inout = rbind(in1sub, inout)
}


##########################################################################
# 3) add natality data 
####################################################################

nat_wonder = read.delim("data_raw/nat1621.txt")


nat = nat_wonder[!is.na(nat_wonder$State.of.Residence.Code),]
nat$state_fips = stringr::str_pad(nat$State.of.Residence.Code, 2, pad = "0")
nat$county_fips = substr(nat$County.of.Residence.Code, nchar(nat$County.of.Residence.Code)-3+1, nchar(nat$County.of.Residence.Code))
nat$fips = paste0(nat$state_fips, nat$county_fips)
nat$births = as.numeric(nat$Births)
nat = nat %>% select(Year, fips, births) #when merging with destid we don't really want state and county fips anymore 

 

######################################################################
# 4) merge birth and death data 
####################################################################

mn = merge(mort, nat, by = c("Year", "fips"))

# only 578 counties here.... YIKES - prob need that DUA since all counties with under 100,000 pop are suppressed  
# for years 2016, 2017, 2018, 2019 (there are of course more years available but since we're working with such a limited sample already, these years should be adequate)


```

There are only `r length(unique(mn$fips))` counties with natality, birth, and death information available. For years `r unique(mn$Year))`, there are a total of `r length(mn$fips)` observations.

IRS migration documentation says: "IRS Migration data for the United States are based on year-to-year address changes reported on individual income tax returns filed with the IRS." Based on this, I think that migrants counted in the 2015-2016 IRS dataset, for example, are migrants whose addresses changed between their 2015 and 2016 tax filings and therefore have moved into / out of a county in 2016 and should be counted in the same way as births/deaths that occurred in 2016.

Determining the exact timing of births, deaths, migration, and population estimates may not be possible. Discrepancies between calculated future population and actual future population are likely due to differences between NVSS and IRS in their data aggregation timelines.

```{r, include= FALSE}

#####################################################################
# 5) merge birth, death, pop with IRS migration estimates 
#######################################################################

#first some manipulations of irs columns and creation of total inflow and outflow columns 

inout = inout %>% filter(destid != origid)
#remove migration counts when origin and destination are the same 


inout$n2 = ifelse(inout$n2 == -1, NA, inout$n2) #from IRS documentation: -1 indicates an unreliable/missing

inout = inout[inout$destid <57000 & inout$origid <57000,] #removing all values that are for "total" / national migration..from documentation: 
# Foreign............................................................. 57
# Total Migration – US and Foreign........................... 96
# Total Migration – US............................................ 97
# Total Migration – Foreign...................................... 98
# Total Migration – Same State..................................97

inout = inout %>% group_by(destid, year) %>% 
  mutate(totin = sum(n2, na.rm = TRUE)) #add a column for total number of migrants to a destid 
outo = inout %>% group_by(origid, year) %>% 
  summarize(totout = sum(n2, na.rm = TRUE))
#create a new dataset summed such that a column represents the total number of migrants out of a origid - this origid will then be merged with destid 
#dimensions appear approx correct - over 2000 observation per year 

inouto = merge(inout, outo, by.x = c("destid", "year"), by.y = c("origid", "year"))

# perhaps the above was not the most efficient... i only need tot in and tot out for each destid... repurposing old code...


totmig = inouto %>% select(destid, year, totin, totout) %>% distinct()
totmig$cyear = paste0("20", substr(totmig$year, 3,4))

#this merge is done such that the migrants are added to the second year of their migration (meaning they are added after the migration has occured) such that in theory the migrants would not be counted in the t0 population estimate 
mn_mig = merge(mn, totmig, mn, by.y = c("destid", "cyear"), by.x = c("fips", "Year"))


dane = mn_mig[mn_mig$fips == "55025",] 
# as far as i can tell, this looks good and all numbers seem plausible 
#population in dane county for 2017 should be equal to the population in 2016 + births in 2016 - deaths in 2016 + in migrants - outmigrants 

mn_mig = mn_mig %>% group_by(fips) %>% 
  mutate(past = as.numeric(lag(Population, order_by = Year)),
    future = as.numeric(lead(Population, order_by = Year)),
    calcd_future = as.numeric(Population) + births + totin - totout - as.numeric(Deaths),
         diff = future - calcd_future,
         perdiff = diff/as.numeric(Population))


```

```{r}
hist(mn_mig$perdiff, main = "Proportion difference between calculated\n population and actual population, as measured by NVSS", xlab = "Proportion Difference")
```

Across ``` r``length(unique(mn_mig$fips)) ``` counties and four years of data, there are minimal differences (+/- 5%) between calculated population (population during prior year + births + in migrants - deaths - outmigrants) and population as estimated by the National Vital Statistics System (NVSS).

These differences are likely to be much more substantial for rural and low population counties for which there is no publicly accessible birth data.

In total, there are `r sum(abs(mn_mig$diff), na.rm = TRUE)` individuals over four years who either cannot be accounted for or are incorrectly assigned using the estimates we've created. (This number is largely meaningless since in our actual analysis we will have at least 7 years of data and (nearly) all US counties, but perhaps this is useful to give a broad sense of the issue.)
