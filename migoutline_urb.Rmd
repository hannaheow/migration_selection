---
title: "Outline: migration paper"
author: "Hannah Olson-Williams"
date: "2023-03-20"
output: html_document
# bibliography: "`r rbbt::bbt_write_bib('mig_selection_references.json', overwrite = TRUE)`"
#bibliography: mig_selection_references.json 
#bibliography: references.json
---



```{r wrangling for dest_mort_change_norace dataset, include = FALSE}
# dest_mort_change_norace dataset 
# First need to determine how much each destination changed from year 0 to year 1. This calculation only requires mortality datafiles.  
# 
# For each fipscode (destination) and each change in year I need:    
# change_totpop_d = totpop_d1 - totpop_d0,   
# change_totrate_d = totrate_d1 - totrate_d0.   
#   
# The dest_mort_change dataset will have the following columns: 
# -change_totpop_d
# -change_totrate_d
# -totpop_d1
# -totpop_d0
# -totrate_d1
# -totrate_d0
# -cyear (formatted like 1617 where 2016 = t0 and 2017 = t1)

library(ggplot2)

load("data_processed/22yearsmort_norace.RData") #the name of this dataset is sc for statecounty 

library(dplyr)
dest_mort_change_norace = sc %>% group_by(fips) %>% 
  mutate(totpop_d0 = lag(totpop, order_by = Year), 
         totrate_d0 = lag(totrate, order_by = Year)) %>% 
  rename(totpop_d1 = totpop, 
         totrate_d1 = totrate,
         year = Year,
         destid = fips) %>% 
  select(year, destid,
         totpop_d0, totrate_d0,  
         totpop_d1, totrate_d1)
library(stringr)
dest_mort_change_norace$cyear = ifelse(dest_mort_change_norace$year == "1999", "NA99", 
                       ifelse(dest_mort_change_norace$year == "2000", "9900", 
                       paste0(str_pad(as.numeric(substr(dest_mort_change_norace$year,
                                                        nchar(dest_mort_change_norace$year)-1,
                                                        nchar(dest_mort_change_norace$year))) - 1, width = 2, side = "left", pad = "0"), 
                              str_pad(substr(dest_mort_change_norace$year, nchar(dest_mort_change_norace$year)-1,
                                             nchar(dest_mort_change_norace$year)), width = 2, side = "left", pad = "0"))))

dest_mort_change_norace$change_totpop_d = dest_mort_change_norace$totpop_d1 - dest_mort_change_norace$totpop_d0   
dest_mort_change_norace$change_totrate_d = dest_mort_change_norace$totrate_d1 - dest_mort_change_norace$totrate_d0   
  
  


```

```{r wrangling for initial_mort_norace dataset, include = FALSE}
# initial_mort_norace dataset
# In a separate dataset, I will collect  all "initial" county and year-specific mortality rates and populations.  
# 
# These initial populations and mortality rates will now be considered "origin" mortality rates and populations. These "initial" values will be from "year 0". This dataset will have the following columns: 
# -origid
# -year (t0)
# -totpop_o


load("data_processed/22yearsmort_norace.RData")

initial_mort_norace = sc %>% rename(origid = fips, 
                                year = Year, 
                                totrate_o = totrate, 
                                totpop_o = totpop) %>% 
  select(origid, year, totpop_o, totrate_o)

```


```{r wrangling for final_mort_norace dataset, include = FALSE}
# final_mort_norace dataset
# Then, using IRS inflow/outflow, I will merge **initial_mort_norace** with **dest_mort_change_norace** such that the following columns are present.   
# -destid
# -origid
# -change_totpop_d
# -totpop_d1
# -totpop_d0
# -cyear
# -totpop_o0
# -totrate_o0
# -totin_d: the total individuals who migrated to destid in year 0 to year 1
# -out_o: the individuals who migrated to destid from origid in year 0 to year 1 
# -totout_d: the total individuals who migrated out of destid in year 0 to year 1
# 


#first some manipulations of irs columns and creation of total inflow and outflow columns 

load("data_processed/12yearsmigfixed.RData")

inout = inout %>% filter(destid != origid)
#updated on 5/16 to remove migration counts when origin and destination are the same 


inout$n2 = ifelse(inout$n2 == -1, NA, inout$n2) #from IRS documentation: -1 indicates an unreliable/missing
inout = inout %>% group_by(destid, year) %>% 
  mutate(totin = sum(n2, na.rm = TRUE)) #add a column for total number of migrants to a destid 
outo = inout %>% group_by(origid, year) %>% 
  summarize(totout = sum(n2, na.rm = TRUE))#create a new dataset summed such that a column represents the total number of migrants out of a origid - this origid will then be merged with destid 
#dimensions are correct: 37857 observations ~ 3142 origid for 12 years

inouto = merge(inout, outo, by.x = c("destid", "year"), by.y = c("origid", "year"))

# inouto[inouto$destid == "55025" & inouto$origid == "55099",]
# inouto[inouto$origid == "55025" & inouto$destid == "55099",]

#first add the dest_mort_change dataset to the inout dataset 
inoutd_norace = merge(inouto, dest_mort_change_norace, by.x = c("destid", "year"), by.y = c("destid", "cyear"))
inoutd_norace = inoutd_norace %>% rename(cyear = year, 
                           year = year.y)
inoutd_norace$lagyear = inoutd_norace$year - 1 #this is the "initial" / time 0 year 

#then add the intial_mort dataset to the inoutd dataset 

inoutdm_norace = merge(inoutd_norace, initial_mort_norace, by.x = c("lagyear","origid"), by.y = c("year", "origid"))
final_mort_norace = inoutdm_norace %>% rename(out_o = n2, 
                                totin_d = totin, 
                                totout_d = totout, 
                                totpop_o0 = totpop_o,
                                totrate_o0 = totrate_o)


```




# ABSTRACT 

Can temporal changes in place-based health outcomes be explained by population mobility? Communities across the United States experience differential rates of inflow and outflow migration which is often connected to resources and structural factors associated with health. To better understand how human migration may affect the health of places over time, we joined county-to-county migration flow data publicly available from the IRS with county-level race-specific mortality rates from the CDC WONDER database. We then were able to create and assess a novel county-level “migration effect” on longitudinal race-ethnicity mortality trends. Using methods from sensitivity analysis, we were able to establish a "selection" effect at the county level. 


# INTRODUCTION
Data for mortality is historically easier to collect and more accurate than other measures of human health. Death has a clear and common definition making it possible to consistently estimate mortality rates across countries, health systems, and time periods.CITE? Mortality as a measure of length of life also has important policy and health equity implications and can be used to assess which individuals or groups are likely to live longest and which individuals or groups may be most in need of additional care.CITE? Thus, mortality rates are often the first place researchers turn when testing a new method. The methods used to estimate and predict mortality are various and numerous, among them singular value decomposition, random walk framework, tensor factorization, agent based modelling - just to name a few. 

Autoregressive models, such as those used in this paper, have commonly been used to estimate mortality rates; for instance, in a 2011 paper, county-level mortality was modeled using spatial autoregressive models in which each county's relative position to other counties as well as its historical mortality rates were taken into account (Yang, Jensen, Haran). Another similar paper (Sparks and Sparks) used an autoregressive model with county-level estimates of mortality that were standardized for measures of income and employment, population density and rurality, and race/ethnicity. Similarly, early in the COVID-19 pandemic, researchers used a spatial autoregressive model to assess the relationships between county-level COVID-19 mortality rates and county-level sociodemographic characteristics (Fielding-Miller, Sundaram, Brouwer). This method has also been extended to age-group and country-level data to explain cohort effects within countries. (Li and Lu 2017) Finally, a 2020 paper adapted this method using age-group data to estimate country-level life expectancy more efficiently, more accurately, and with greater precision for younger populations (Shi). 

In this paper, we extend previous autoregressive models to account for county interconnectedness. We develop a novel "migration term" which accounts for the mortality rates of individuals who have either moved to a county of interest during a given time period. We then use this migration term to assess the possibility of health-related **selection of counties as destinations for migration**.(bolded because maybe there are better ways to describe?) 

According to Lee’s theory of migration24, migration is selective, meaning that the individuals who migrate are not a random sample of the population of the origin. Migration occurs in response to a “push” or a “pull” – migrants are “pushed” to leave an origin and “pulled” to a destination. “Pull” factors are more often associated with positive selection; migrants who are “pulled” to a destination due to perceived benefits are more likely to have high income or education status. Contrarily, migrants who are “pushed” to leave an origin are likely to have faced hardship in some form. In some cases, this is a negatively selected group including individuals who have lost jobs or suffered from climate change events; in other cases, an entire population may be “pushed” to migrate due to war or famine. Migration is often bimodal in that only the most advantaged and the least advantaged individuals relocate. This logic could be extended to the health distribution of migrants: only the most and least healthy individuals migrate.

Selection for migration has been studied many times before. One such study simulated the effects of climate change on population dynamics using a model capturing "emigrant self-selection by health" which could be either positive or negative - positive meaning that a migrant was likely to be healthier than their non-migrant peers or negative meaning that a migrant was likely to have migrated in search of better health.(Reuveny) 

Another study of internal migration patterns in Indonesia found that with respect to health, young migrants were positively selected to migrate while older migrants were negatively selected to migrate25. In other words, as age increases, older migrants are more likely to be “pushed” to leave an origin, possibly due to adverse, health while young migrants are more likely to be “pulled” to a destination, possibly seeking jobs. Thus, we use age-adjusted mortality rates (available through CDC WONDER) in an effort to reduce the effects of age. 

According to Norman and colleagues, migrants who move from more resource depleted regions to less resource depleted regions have better health on average than the population in their destination while migrants who move from less depleted regions to more depleted regions have worse health on average than the population in their destination.26 Additionally, when the barriers between origin and destination are particularly high, migrants are often healthier on average than the people living in their destination, either because they have been selected through the migration process or because unhealthy people are less likely to choose to move when the barriers are high.27

In our paper, we assess migration where the barriers for migration are relatively low and relatively constant: between United States counties. Migration between counties typically does not require overcoming hazardous terrain or attainment of visas and other government documentation.CITE Data accounting for demographic patterns in internal US migration is difficult to obtain or largely unavailable. Though there are 5-year estimates available from the American Community Survey, county-to-county migration flow data are only available for each year from the IRS which does not include individuals who do not file taxes. CITE. Thus, because our unit of analysis is a US county and because our data source (IRS) includes individuals who have filed taxes and are relocating within the US, we assume that any selection that occurs is the result of "self-selection" rather than selection by or through the process of migrating itself - in other words, individuals who migrate are migrating because they have chosen to migrate, and there is little to no chance of removal of migrants from the potential migrant pool during the process of migrating.  



# METHODS 
### DATA 
We combined estimates of county-level age-adjusted mortality rates available through CDC WONDER with estimates of county-to-county migration flows available from the IRS. Both datasets are publicly accessible. We have made our analytical dataset publicly available as well. **todo** Data represents the years 2010 through 2019. We chose to remove the year 2020 from our dataset because across the US, the median county-level mortality rate rose from `r median(final_mort_norace$totrate_d1[final_mort_norace$year == 2019], na.rm = TRUE)` per 100,000 in 2019 to `r median(final_mort_norace$totrate_d1[final_mort_norace$year == 2020], na.rm = TRUE)` per 100,000 in 2020. This unprecedented change in mortality is difficult to model since it occurred so unpredictably **citations here from other studies that have removed 2020 data???**
The plot below **(DRAFT)** highlights this shift in mortality rates. 


```{r removal of year 2020, echo = FALSE, warning=FALSE, message=FALSE}
# JUSTIFICATION OF REMOVAL OF YEAR 2020 



#final_mort_norace$totrate_d1[final_mort_norace$year == 2020]

ggplot(final_mort_norace) + 
  geom_bar(aes(factor(year), totrate_d1), stat = "summary", fun= "median") +
  theme_bw() + 
  xlab("") + 
  ylab("Median mortality rate across all US counties")

norace_no2020 = final_mort_norace[final_mort_norace$year != 2020,]
final = na.omit(norace_no2020)


```

**discussion of missingness and removal of missings**



### VARIABLES AND MODELS 

To assess migration, we created a novel "migration term" which can be thought of as a weighted average of the mortality rates of all counties that have migrants to each destination county. This approach requires the assumption that all migration occurs at random - ie the average mortality rate of any group of migrants from a specific origin county is approximately equivalent to the mortality rate of their origin county.  
We calculated the following for each change in year and for each destination county: 

$$ 
migration = \frac{ \sum_{d=1}^{k} { out_o rate_o0 } + rate_d0 (pop_d0 - out_d) }{ \sum_{d=1}^{k} { out_o } + (pop_d0 - out_d)} 
$$ 

where    
$out_o$ represents the number of migrants from a unique origin county $o$ who migrated to a destination county $d$ between two years of interest.   
$rate_o0$ is the mortality rate of an unique origin county $o$ at initial year $0$   
$rate_d0$ is the mortality rate of an unique destination county $d$ at initial year $0$    
$pop_d0$ is the population of an unique destination county $d$ at initial year $0$     
$out_d$ is the number of migrants who left each unique destination county between two years of interest.    


```{r calculate migterm, include = FALSE}
##################################################################################
# NON RACE-SPECIFIC MIGTERM 


    
migterm = final %>% group_by(destid, year) %>% 
    mutate(migterm = (sum(out_o *totrate_o0) + totrate_d0 * (totpop_d0-totout_d))/(sum(out_o) + (totpop_d0-totout_d))) %>% 
    distinct(destid, year, totrate_d0, totrate_d1, .keep_all = TRUE)


#corrplot::corrplot(cor(migterm_norace[,c("rmigterm_amy", "rmigterm", "totrate_d0", "totrate_d1")]))

#save(migterm, file = "H:/amy/migration/3mods/migterm.Rdata")

```

The resulting weighted average is highly correlated with county-level mortality. **note here about multicollinearity??**  

We used a multilevel autoregressive model to explain county and race-specific age-adjusted mortality rates across 3000 US counties. We tested several models and used BIC to determine the best fitting model. BIC is commonly used to determine models with greatest explanatory power (CITE).   
Our initial model included a random intercept for each destination county and random slope for each time covariate. We include random intercepts for each destination county in an attempt to account for some variation between counties, as recommended by Greenberg's assessment of best practices for ecological studies CITE. We then iteratively added splines for the prior year's average county-level mortality rate and the migration term. Our initial model is similar to autoregressive county-level mortality models used by (Sparks and Sparks), (Yang, Jensen, Haran), and (Fielding-Miller, Sundaram, Brouwer). 

We found that models including our weighted average migration term did not have as much explanatory power as models that included only the prior year's average county-level mortality rate. This suggests that migration does not occur at random - if migration occurred at random, we would expect a weighted average of the expected mortality rates of all potential migrants to be equivalent, if not more predictive, of the future mortality than the prior year's mortality rate.  




```{r model selection, echo = FALSE, message=FALSE, warning=FALSE}
# WITHOUT RACE - TOTAL COUNTY VALUES ONLY 

library(splines)
library(lme4)

migmodm = migterm %>% arrange(year) %>% 
  group_by(destid) %>% 
  filter(n_distinct(totrate_d1)>4)


migmtemp = na.omit(migmodm) #no additional NAs were removed so we're gooooood to go
mn = data.frame(migmodm)

mnn = mn %>% 
 arrange(year) %>% 
 group_by(destid) %>% 
 mutate(t = row_number())

mnn$ft = as.factor(mnn$t)

#(1|fips) is a random intercept; each fips's reg line is shifted up/down randomly with mean 0
#(1+time|fips) includes a random slope for time; the effect of time differs randomly from fips to fips 
m1_norace = lme4::lmer(totrate_d1 ~ ft + totrate_d0 + (1+t|destid) + migterm, data = mnn,
                control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))



m1_nomig = lme4::lmer(totrate_d1 ~ft + totrate_d0 + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_nomigscale = lme4::lmer(totrate_d1 ~ft + ns(totrate_d0, 1) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_nomig2 = lme4::lmer(totrate_d1 ~ft + ns(totrate_d0, df = 2) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_nomig3 = lme4::lmer(totrate_d1 ~ft + ns(totrate_d0, df = 3) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_nomig4 = lme4::lmer(totrate_d1 ~ft + ns(totrate_d0, df = 4) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_nomig5 = lme4::lmer(totrate_d1 ~ft + ns(totrate_d0, df = 5) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_nomig6 = lme4::lmer(totrate_d1 ~ft + ns(totrate_d0, df = 6) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_nomig7 = lme4::lmer(totrate_d1 ~ft + ns(totrate_d0, df = 7) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_nomig9 = lme4::lmer(totrate_d1 ~ft + ns(totrate_d0, df = 9) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))


m1_norate = lme4::lmer(totrate_d1 ~ft + migterm + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_norate3 =lme4::lmer(totrate_d1 ~ft + ns(migterm, df = 3) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_norate4 = lme4::lmer(totrate_d1 ~ft + ns(migterm, df = 4) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_norate5 = lme4::lmer(totrate_d1 ~ft + ns(migterm, df = 5) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_norate6 = lme4::lmer(totrate_d1 ~ft + ns(migterm, df = 6) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_norate7 = lme4::lmer(totrate_d1 ~ft + ns(migterm, df = 7) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_norate9 = lme4::lmer(totrate_d1 ~ft + ns(migterm, df = 9) + (1+t|destid), data = mnn, 
                     control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))




m1_spline1212 = lme4::lmer(totrate_d1 ~ ft + ns(totrate_d0,df = 12) + (1+t|destid) + ns(migterm,df = 12), data = mnn,
                control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_spline55 = lme4::lmer(totrate_d1 ~ ft + ns(totrate_d0,df = 5) + (1+t|destid) + ns(migterm,df = 5), data = mnn,
                control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_spline44 = lme4::lmer(totrate_d1 ~ ft + ns(totrate_d0,df = 4) + (1+t|destid) + ns(migterm,df = 4), data = mnn,
                control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_spline33 = lme4::lmer(totrate_d1 ~ ft + ns(totrate_d0,df = 3) + (1+t|destid) + ns(migterm,df = 3), data = mnn,
                control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
m1_spline22 = lme4::lmer(totrate_d1 ~ ft + ns(totrate_d0,df = 2) + (1+t|destid) + ns(migterm,df = 2), data = mnn,
                control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

m1_choice = m1_spline44

#summary(m1_choice)

#there are ten coeffs that are not part of the splines
np = (length(fixef(m1_choice)) - 10) / 2
ageratecoeffsum = sum(fixef(m1_choice)[11:(10+np)])
migtermsum = sum(fixef(m1_choice)[(10+np+1):length(fixef(m1_choice))])

```

First we compared models without a migration term to models with a migration term and determined that models with and without a migration term performed approximately equivalently, with the lowest BIC values occurring for models with splines with 5 degrees of freedom for both the migration term and mortality. 

Without the migration term included:

```{r model selection without migterm, echo = FALSE}
BIC(m1_nomig, m1_nomig3, m1_nomig4, m1_nomig5, m1_nomig6, m1_nomig7,m1_nomig9) 
  
```
The best performing model (lowest BIC) has a spline with 5 degrees of freedom. Predicted data for this model is shown below.  

```{r plot for m1_nomig5, echo = FALSE, message=FALSE, warning=FALSE}

tempdf = mnn[c(rep(1,14)),] #dummy data - first 14 rows of original dataframe 

tempdf$totrate_d0 = c(seq(200, 1500, by = 100)) #replace with old mortality rates 



preddata = predict(m1_nomig5, tempdf)
plotdata = data.frame(cbind(x = seq(200, 1500, by = 100), y = preddata))

ggplot(plotdata) + geom_point(aes(x=x, y = y), color = "dark green") + 
  xlab("Potential initial mortality rate") + 
  ylab("Predicted mortality rate") + 
  theme_bw() +
  geom_abline(slope = 1) + 
  annotate("text", x = 1300, y = 1400, angle = 45, label = "Reference y = x") + 
  tune::coord_obs_pred()

```

As we can see, prior (or "initial") age-adjusted mortality rate affects predicted mortality rate, with lower initial mortality rates being associated with lower predicted mortality rates. Though we might expect the relationship between prior and predicted age-adjusted mortality to be close to 1 to 1, in our model, this is not the case. In the plot above, the y=x reference line highlights this gap. Our model reduces the noise at the extremes; all predicted values are centered around the mean.     
   
Next we compare models that do not include mortality rates and instead include a weighted average migration term. The BIC scores of these models are shown below: 

```{r model selection for no mortrate, echo = FALSE, message=FALSE, warning=FALSE}
BIC(m1_norate, m1_norate3, m1_norate4, m1_norate5, m1_norate6, m1_norate7, m1_norate9)
```
Again, the best performing model with migterm instead of mortality has a spline with 5 degrees of freedom. We display the predicted data for this migterm only model in combination with the predicted data from the prior mortality only model.   

```{r plot for m1_norate5, echo = FALSE, message=FALSE, warning=FALSE}
tempdf$migterm = seq(200, 1500, by = 100)
preddatanorate = predict(m1_norate5, tempdf)


preddatanomig = predict(m1_nomig5, tempdf)
plotdata = data.frame(cbind(x = seq(200, 1500, by = 100), nomig = preddatanomig, norate = preddatanorate))


ggplot(plotdata) + geom_point(aes(x=x, y = nomig, color = "dark green")) + 
  geom_line(aes(x=x, y = nomig, color = "dark green")) + 
  geom_point(aes(x = x, y = norate, color = "dark red")) + 
  geom_line(aes(x = x, y = norate, color = "dark red")) + 
  xlab("Potential initial mortality rate") + 
  ylab("Predicted mortality rate") + 
   scale_color_manual(labels = c("With migterm", "With mortality rate"), 
                     values = c("dark red", "dark green")) +
  labs(title = "", color = "") + 
  theme_bw()+
  geom_abline(slope = 1) + 
  annotate("text", x = 1300, y = 1400, angle = 45, label = "Reference y = x") + 
  tune::coord_obs_pred() 



tempdf = mnn[c(rep(1,11)),] #dummy data - first 14 rows of original dataframe 
tempdf$totrate_d0 = c(seq(700,950, by = 25)) #replace with old mortality rates (this is now based on the IQR instead of massive range)
tempdf$migterm = seq(700,950, by = 25)

preddatanorate = predict(m1_norate5, tempdf)


preddatanomig = predict(m1_nomig5, tempdf)
plotdata = data.frame(cbind(x = seq(700,950, by = 25), nomig = preddatanomig, norate = preddatanorate))


ggplot(plotdata) + geom_point(aes(x=x, y = nomig, color = "dark green")) + 
  geom_line(aes(x=x, y = nomig, color = "dark green")) + 
  geom_point(aes(x = x, y = norate, color = "dark red")) + 
  geom_line(aes(x = x, y = norate, color = "dark red")) + 
  xlab("Potential initial mortality rate") + 
  ylab("Predicted mortality rate") + 
   scale_color_manual(labels = c("With migterm", "With mortality rate"), 
                     values = c("dark red", "dark green")) +
  labs(title = "", color = "") + 
  theme_bw()+
  geom_abline(slope = 1) + 
  annotate("text", x = 730, y = 740, angle = 45, label = "Reference y = x") + 
  tune::coord_obs_pred() 
 




```

As we can see, the predicted age-adjusted mortality rates appear to be unaffected by the modelling choice of whether to include the migterm or the prior year's mortality rate. Even after emphasizing potential initial mortality rates that are between the 25% and 75% percentile, it is difficult to distinguish between the two models.  


When splines were included for both migration and mortality, BIC continued to drop, suggesting that migration continued to have an effect on the explanatory power of the model.

```{r, echo = FALSE}
BIC(m1_nomig5, m1_norate5, m1_spline22, m1_spline33, m1_spline44, m1_spline55, m1_spline1212)
```


Based on the table above, our final model includes splines with five degrees of freedom for both mortality and the migration term. 
The sum of the mortality coefficients is `r ageratecoeffsum` while the sum of the migration term coefficients is `r migtermsum` for a difference of `r ageratecoeffsum - migtermsum`.  

```{r , echo = FALSE, message=FALSE, warning=FALSE}


tempdf = mnn[c(rep(1,14)),] #dummy data - first 14 rows of original dataframe 

tempdf$totrate_d0 = c(seq(200, 1500, by = 100)) #replace with old mortality rates 


tempmigdf = rbind(tempdf, tempdf, tempdf) #need to do it this way bc rep causes errors 


tempmigdf$migterm = c(tempmigdf$totrate_d0[1:14] - 10, 
                      tempmigdf$totrate_d0[15:28] + 10, 
                      tempmigdf$totrate_d0[29:42]) #vary the migterm based on mortrate by 10

tempmigdf$group = c(rep(-10, 14), rep(10, 14), 
                    rep(0, 14))
plotdata = data.frame()

#for each variant of migterm, create a predicted value 
for (i in 1:3) {
  gi = unique(tempmigdf$group)[i]
  preddata = predict(m1_spline55, tempmigdf[tempmigdf$group == gi,])
  pd = data.frame(cbind(x = seq(200, 1500, by = 100), y = preddata))
  pd$group = gi
  plotdata = rbind(plotdata, pd)
}




ggplot(plotdata, aes(x= x, y = y, group = group, color = as.factor(group))) + geom_point() + geom_line()+
  xlab("Potential initial mortality rate") + 
  ylab("Predicted mortality rate") + 
  theme_bw() +
  geom_abline(slope = 1) + 
  annotate("text", x = 1300, y = 1400, angle = 45, label = "Reference y = x") +  
  tune::coord_obs_pred() + 
  scale_color_manual(labels = c("Migterm is less than mortality", "Migterm and mortality are equal", "Migterm is greater than mortality"), values= c("dark red", "black", "dark blue")) +
  labs(color = "", title = "Migterm relative to mortality rate")
  
  


```

The migterm is essentially a weighted average of the mortality rates of each of the origin counties. Therefore, migration and mortality are closely aligned. As such, to study the effects of the migterm, we vary its value relative to mortality rate. As shown in the plot above, when the migterm is larger than the potential initial mortality rate, the predicted mortality rates will be higher when the initial mortality rate is at either extreme. On the other hand, when the initial mortality is near the median value of all mortality rates, the predicted mortality rate is lower when the migterm is less than the mortality rate than when the migterm is equal or greater than the mortality rate. 

Taking the center of the plot to be closest to "truth", we see that when the migterm is greater than mortality, the predicted mortality rate is larger than when the migterm is less than or equal to mortality. Of course, we know that the migterm will only be greater than mortality when the average mortality rate of all origin counties is greater than the initial mortality rate of each destination. Thus, when migration occurs from "less healthy" origin counties, we predict that mortality will become worse in destination counties as well. This phenomenon is more clearly illustrated in the plot below which shows only the initial mortality rates between the 10th and 90th percentile. 




```{r 10-90qq plot, echo = FALSE, message=FALSE, warning=FALSE}
lowlim = round(quantile(mnn$totrate_d0, probs = 0.1, na.rm = FALSE), -1)
uplim = round(quantile(mnn$totrate_d0, probs = 0.9), -1)
nm = (uplim - lowlim)/10 +1


tempdf = mnn[c(rep(1,nm)),] #dummy data - first 14 rows of original dataframe 

tempdf$totrate_d0 = c(seq(lowlim, uplim, by = 10)) #replace with old mortality rates (this is now based on the IQR instead of massive range)


tempmigdf = rbind(tempdf, tempdf, tempdf) #need to do it this way bc rep causes errors 


tempmigdf$migterm = c(tempmigdf$totrate_d0[1:nm] - 10, 
                      tempmigdf$totrate_d0[(nm+1):(nm*2)] + 10, 
                      tempmigdf$totrate_d0[(nm*2+1):(nm*3)]) #vary the migterm based on mortrate by 10

tempmigdf$group = c(rep(-10, nm), rep(10, nm), 
                    rep(0, nm))
plotdata = data.frame()

#for each variant of migterm, create a predicted value 
for (i in 1:3) {
  gi = unique(tempmigdf$group)[i]
  preddata = predict(m1_spline55, tempmigdf[tempmigdf$group == gi,])
  pd = data.frame(cbind(x = seq(lowlim, uplim, by = 10), y = preddata))
  pd$group = gi
  plotdata = rbind(plotdata, pd)
}




ggplot(plotdata, aes(x= x, y = y, group = group, color = as.factor(group))) + geom_point() + geom_line()+
  xlab("Potential initial mortality rate") + 
  ylab("Predicted mortality rate") + 
  theme_bw() +
  geom_abline(slope = 1) + 
  annotate("text", x = 730, y = 740, angle = 45, label = "Reference y = x") +  
  tune::coord_obs_pred() + 
  scale_color_manual(labels = c("Migterm is less than mortality", "Migterm and mortality are equal", "Migterm is greater than mortality"), values= c("dark red", "black", "dark blue")) +
  labs(color = "", title = "Migterm relative to mortality rate")
  



```
In the plot above, we see that the difference between the migterm and mortality becomes less significant at the extremes. When mortality is between approximately 750 and 900, the slopes of the three lines are approximately equal, suggesting that migration has an approximately constant effect on predicted mortality when baseline mortality is between 750 and 900. However, at the tails (initial mortality less than 750 or greater than 900), we see that the predicted mortality rate is similar regardless of the difference between the migterm and mortality. This indicates that for counties with extremely low mortality rates (very healthy) and for counties with extremely high mortality rates (very unhealthy) the effect of migration on predicted mortality has little to no effect. This may be an indicator of "selection" occurring at the extremes. In our framework, all migration occurs at random and should therefore affect all counties equally, regardless of initial mortality rate. However, the plot above indicates that this may not be the case.  In the next section, we describe how this finding indicates the process of "selection for migration" 



### SELECTION 

To assess the effects of migration on county-level health, we treat county-level mortality at time 0 as the "treatment" and county-level mortality at time 1 as the "outcome". Migration can then be thought of as an unknown confounding variable, assuming the terminology used by VanderWeele and Ding (CITE). Each county experiences differential rates of inflow and outflow migration which is unknowingly related to average county-level health at time 1 (outcome).   **add DAG here**

We use county-level data because that is what is available, but also because we cannot know exactly which individuals are in each county at time 0 and at time 1, creating treatment and outcome groups that differ at the individual-level, but not at the county-level. Of course there is information lost when using group-level data, and the downsides of such an ecological study design have been enumerated many times previously (CITE); however, by studying county-level data, we can draw attention to environmental county-level health factors - factors that are likely to have different effects when comparing individuals but may remain largely constant when comparing groups or counties. **more here about ecological fallacy, maup, bimodal patterns??? **
Additionally, by using a multi-level model, one possible partial solution to ecological fallacy bias as outlined by Greenland CITE, we account for some of the variation across and within groups. 

First, we must assume that our system is closed - the sum of county populations at time 0 (treatment) is equal to the sum of county populations at time 1 (outcome). This is a heroic assumption, but it is necessary given our data source - we do not readily have information on county-level international migration, and while we could include county-level birth and death data, this is not necessary since we our county-to-county migration flow data includes only individuals who have filed taxes, and therefore already systematically reduces the likelihood that we count individuals who are either very old or very young. CITE  

In order to test for selection bias among the group that are available at time 1 (the time period after migration - the "outcome" group) we require a second initial assumption: all counties experience the same rates of inflow and outflow migration. Anecdotally, we know that not all counties experience the same rates of inflow and outflow - some counties are more desirable, attracting many new residents from counties that are less desirable which experience high rates of outflow. 


### Model of migration at random 

$$ E[y_t | x_{t+1}=j] = \sum_k{E[y_t|x_{t+1}=j, x_t = k]} * P(x_t= k | x_{t+1} = j)$$ 


The expected value of mortality at time t given that a migrant moved to j at time t+1 is equal to the sum of the expected mortality at time t given that the migrant moved to j at time t+1 and came from origin k (of which there are multiple which we sum across) times the probability that the migrant was at origin k at time t and moved to j at time t+1. 

However, when selection bias occurs, the probability of migration depends on health. Therefore, the desired predicted outcome and the inputs are not independent.











##### delete later?


##### ideas for what to do about insignificance/problematic of migterm 
- subset to focus on counties with "extreme" patterns of migration and then look at the effects of mig on health  
- skip the term all together and do a simulation instead (see "agent based sim.Rmd")






Thus, we test two different scenarios, borrowed from Cornfield: 

a) all groups should equalize over time - even if counties experience very different rates of inflow and outflow, they will become more similar over time  
  i) this may violate our (unstated) hypothesis that migration can be self-perpetuating......   

b) exclude the counties with the lowest rates of inflow from the potential   
  i) should not change results - healthy counties will stay healthy, unhealthy counties will stay unhealthy   
  ii) another simulation needed here   
  iii) might just prove that we have a series of mini networks (ie the same counties migrate amongst themselves)   
  iv) cannot disentangle size from effect - of course removing small contributors will have small effect   


### Defining the outcome 

a) outcome variable: mortality AFTER migration ; but this is difficult to parse because migration is constant. 

but we want the "outcome" of our analyses to be a) a term assessing the average effect of migration on county-level health outcomes; and b) a quantitative understanding of how selection bias may affect longitudinal trends - ie a percent that the relationship between mortality at time 0 and mortality at time1 may be explainable through unmeasured confounding (ie migration)

b) a model for mortality rates: we could potentially use any county-level health outcome (health outcomes available through CHRR include premature death, life expectancy, child mort, infant mort, poor/fair health, poor mh days, poor ph days, low bw, physical distress, mental distress, diabetes prevalence, hiv prevalence); however, mortality measures are the only measures of county-level health outcomes for which subgroup (race, age) are available. 
We could potentially examine a health factor in place of a health outcome - high school completion has strong potential; other strong variables: children in poverty, unemployment, severe housing cost burden. I think using one of these variables as the primary outcome might push us further away from epidemiology and into econ/sociology. Maybe it makes sense to perform our analyses using a health outcome (mortality) first and then apply to a health factor to see our findings hold. 

Risks of mortality: the population that is migrating is unlikely to be the population that is dying.....seems plausible that trends in county-level mortality might be better explained by trends in county-level migration fifty years earlier..... but age-adjusted county-level mortality rates are a commonly used proxy for health of a county overall...... a 1983 report by the WHO recommending measures in mortality and morbidity to understand the relationship between health and migration (Gushulak), mortality has been used to assess risks of death in SA and moz (collinson), etc etc 












```{r random notes keep for now, include = FALSE}


# Modeled outcome:     
# Expected value of county-level mortality at time t+1 given that county d (destination) receives migrants who were at county j at time t. Let y represent the mortality rate of a destination county d while x represents a vector of length n of mortality rates of n origin counties where j refers to a specific origin county.   
# $$  E[y_{t+1} | x_t=j] $$
# which can be represented as the average mortality rates of all origin counties at time t, given that at time t+1 there are migrants from county j in destination d, times the probability that migrants from j moved to d. 
# 
#  $$ = \sum_n{E[x_t=j | migration occurred] * P(of migration)} = $$
# $$ \sum_n{E[x_t=j | y_{t+1} = j] * P(y_{t+1}=j | x_t = j)}$$  
# 





# # notes from 4/3 
# 
# why do we need a new model for mortality? because counties do not exist in isolation 
# purely from a predictive standpoint - movement improves the model 
# by studying movement we can then identify selection bias 


# DAG: measured covariates(selection/health - do we have this???) -> treatment (migration) -> outcome(mortality)
# where both treatment and outcome are affected by unmeasured confounders 
#   
# 
# evalue = minimum strength of assoc (risk ratio -extension to rate ratio) that an unmeasured confounder would need to have with both the treatment and the outcome conditional on the measured covariate to explain away a treatment-outcome association = RR + sqrt(RR(RR-1)) 
# 
# RR = treatment mortality/ control mortality = mort of movers/ mort of stayers 
# 
# We cannot easily calculate the RR of each county since we don't know exactly who moved and who stayed. 
# 
# VanderWeele and Ding: countymortrate = RReu RRud / (RReu + RRud - 1) \ 
# RReu = max RR for any specific level of unmeasured confounders comparing with and without treatment with adjustment for measured covars \  
# RRud = max RR for the outcome comparing any 2 categories of unmeasured confounder with adjustment for measured covars \ 
# 
# Can we simulate this somehow???? 
# 
# 
# 
# 
# 
# 
# # notes from today
# 
# add splines asap
# treat time0 as exposure and time1 as outcome 
# then migration can be considered the unknown confounding var 
# think more about ecological biases 
# 
# rosenbaum paper
# randomized inference tests (fishers is one of these)
# 
# mortality at time 0 = average mort of all people there = proportion of least healthy * mort rate of least healthy + proportion of most healthy * mort rate of most healthy 
# 
# also read greenland 
# 
# 
# 
# 
# 
# 
# 
# # notes on greenland 
# - ecological variation in the distribution of individual effects can bias ecologic estimates of contextual effects ; common in studies of "ecosocial factors" and health outcomes bc social context is not randomized across typical analysis units (counties)
# 
# ecologic data contain only marginal observations on the join distribution of individually defined confounders and outcomes 
# 
# ecologcial studies are better addressed by multilevel study designs which obtain and use individual as well as group-level data 
# 
# problems due to inappropriate aggregation and problems due to temporal changes in covariate distribution 
# 
# variables of public health importance are summaries of individual level distributions: prevalence, incidence, mortality, and life expectancy are all avarages!! and contextual variables such as "neighborhood social class" are typically measured using proxies that are averages (avg income)
# 
# ### multilevel methods
# need to use ecological data since it is what is available 
# apply individual-level risk models to within-rgion survey data and aggregate the resulting individual risk estimates for comparison to observed ecologic rates 
# suppose we have covariate vector X measures on Nk surveyed individuals in region k; we compare the area rate rpedicted from the model applied to the survey data where the sum is over the surveyed individual..... regression analogue of indirect adjustment 
# prentice and sheppard propose estimating individual params by directly regressing the rates on the survey data using the induced aggregate model --> estimate regional specific averages by the sample averages 
# within region surveys obtain outcome as well as covariate data on individuals 
# multilevel has advantage of confounder control achievable in individual level studies and exposure variation achievable in ecological studies....must assume stability of exposure and covariate distributions over time s.t. survey distributions are representative of the distributions that determined the ecologic rates; 
# 
# without individual level data, multilevel analysis can be applied to ecologic data via nonidntified random coeff regression 
# specify a hierarchical prior distribution for params not identified by data 
# distribution for the exposure effect of interest is then updated by conditioning on the available data -> multilevel extension of random effects ecologic regression 
# 
# noncomparability - this is an issue for our study!!! IRS data represent only the population that files taxes, not the total population and ACS data are modeled to include total population (but they are modeled.....) 
# better to use crude/non standardized rates and control for ecologic demographic differences by entering multiple age-sex-race-distribution categores .... hmmmm interesting 
# i wonder if we could use differences between ACS and IRS as a toy for this issue 
# 
# ecological regression estimates can be very sensitive to erros in exposure measurement 
# ecological covariates are direct summaries of individual measures but this isn't always the case becasue often ecological vars are proxies for other things 
# 
# potential for bias does not indicate presence of bias 


```







```{r, include = FALSE}

##### SCRATCH 


# In addition to age, net migration could potentially be considered one factor in estimating whether a county is experiencing push or pull migration. For instance, if a county has negative net migration for several years in a row, we might consider that people leaving the county are being “pushed.” A county with positive net migration might contain many new migrants who were “pulled.” Of course, this is an oversimplification. But since we are working with county-level data, we will not be able to describe individual reasons for migrating.





# Within county Ci, we call each of these individuals xci. 
# Let's say that 10% of the individuals within county Ci migrate in year y. Then the probability of migration (treatment) for each xci is pxci = 0.1. 


# 
# 
# Thus, we create a simulation, testing the effects of migration on health with and without seelction bias 
# 
# 
# 
# If we want to assess the probability of an individual to move, we must treat all analyses as prospective - within a given county, if we select an indiviaul at random, there is a 
# 
# To model this phenomenon, we assess the migration selection bias or MSB. MSB is an extension of traditional selection bias analyses which require 
# First, via Cornfield, we assume that the counterfactual is true. If migration does not /cause/ health in a place, we must find some unmeasured or unstudied variable that does /cause/ health in a place. There are many potential examples: local health policies, age distributions, air pollution, water quality, average income, education, etc - but each of these things, outside of air pollution, is related to the people who live within each county and thus related to the migration to/from a county - 





########################################################################
# notes 

# race on backburner, add splines for 
# For model selection: add splines on migterm and totrate term  
# Xvalue = migration term or previous time point mortality 
# Yvalue  = predicted contribution of each xvalue on mortality 
# 
# Use AIC and BIC – BIC better for explanation; AIC better for prediction 
# 
# evalue 
# 2 groups: very healthy, very unhealthy 
# treatment: moving; untreated: stay 
# odds of treatment 
# 
# 
# cornfield and vanderweel and rosenbaum (last) 
# https://amy-cochran.gitbook.io/causal-inference/sensitivity-analyses/manski
# 
# model1: no migration
# model2: model2 no sleection - completely at random
# model3: sensitivity analysis 

```

hierarchical model, multilevel, mixed/random effects 
mle? or bayesian? rstan package 




